# Trajectory Aligner Module
3D Slicer module for creating and placing virtual depth electrode arrays
![TrajectoryAlignerforGif(GIF)](https://github.com/user-attachments/assets/92e1f7ce-95e1-448c-a425-f8489e257730)

## Installation

1. Download the repo
2. Open 3D Slicer
3. Go to Edit > Application Settings
<img width="572" height="163" alt="image" src="https://github.com/user-attachments/assets/5edf6a47-ff44-4663-ab37-4543426fbf4d" />

4. Go to "Modules" tab
6. In "Additional module paths" section, click the double arrow to reveal the "Add" and "Remove buttons
7. Click "Add"
<img width="830" height="580" alt="SlicerModulesTab" src="https://github.com/user-attachments/assets/a3b1614d-33e8-4557-9072-c0e0d388fd15" />

9. Add the folder "Trajectory Aligner" from the repo to the path list
10. Click "Ok" and restart if necessary  



## Use Instructions

1. Open the Module (Will be listed under the category "DiSc Utilities")
<img width="1693" height="913" alt="image" src="https://github.com/user-attachments/assets/56b7e2f6-4ff6-4006-8f3b-f6341140c14c" />

2. Create or select a line markup to define the trajectory using "Trajectory Settings > Active Trajectory". 
<img width="1696" height="908" alt="image" src="https://github.com/user-attachments/assets/051a2929-cc90-48c2-8541-f9cf97379702" />

3. The first point will be the distal end (tip/deepest) while the second point will be the proximal end (entry/surface). The tip maps to the origin of the linked objects, while the proximal shaft point is used to define the trajectory. The length of the trajectory line does not matter, only the angle.
4. A linked transform matrix will automatically update as you move the line points
5. Go to the "Transforms" Module (base module from Slicer) and select the transform matrix generated by the module as  the "Active Transfom"
<img width="1692" height="869" alt="SlicerActiveTransform" src="https://github.com/user-attachments/assets/c9869be5-9167-46f7-93e7-6faefb16d6c0" />

6. Objects can be linked to the Trajectory Line by going to the "Apply Transform" section and selecting items from your scene and clicking the green right arrow to add it to the Transformed list
<img width="1695" height="912" alt="SlicerLinkedTransform" src="https://github.com/user-attachments/assets/78ee6f7b-155b-45be-8bab-ee91832dda9e" />

7. Now moving the ends of the trajectory line will move the linked objects as well
<img width="1694" height="911" alt="image" src="https://github.com/user-attachments/assets/324e76f8-239a-4e6b-9c05-664d81cfbac4" />

8. Back in the  Trajectory Aligner Module, objects linked to the trajectory can be rotated around the trajectory axis using "Fine Tune > Twist". Linked objects can also be translated along the trajectory using "Fine Tune > Trajectory Offset" (Note that the tick box increases in increments but any value in mm can be typed in for a more precise offset)
<img width="772" height="906" alt="SlicerFineTune" src="https://github.com/user-attachments/assets/16d345af-dc9e-4e16-b6ec-baa12b48dfcc" />



## Notes and Considerations

* Only the line currently selected in "Active Trajectory" will be editable, other trajectories will be locked. Thus, you MUST choose the trajectory to be edited in the "Trajectory Settings > Active Trajectory" section 
* By default, any meshes or markups to be ilnked should be aligned to the vector [0, 0, 1] by default. In exceptional cases, this alignment vector can be changed in "Origin Settings > Original Unit Vector"
